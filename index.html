<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <meta name="Keywords" content="" />
        <meta name="Description" content="" />
        <title>点餐</title>
        <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
        <link href="css/style.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="js/custom.common.js"></script>
        <!--[if lt IE 9]>
            <script src="js/html5shiv.js" type="text/javascript"></script>
            <script src="js/respond.min.js" type="text/javascript"></script>
        <![endif]-->
    </head>

    <body>
        <div class="main_body">
            <div class="wp clearfix">
                <div class="left_area f_l">
                    <div class="head clearfix">
                        <h2 class="f_l">请选择喜欢的菜色</h2>
                        <div class="nav f_r">
                            <ul>
                                <li><a href="#">粤菜</a></li>
                                <li><a href="#">湘菜</a></li>
                                <li><a href="#">川菜</a></li>
                                <li><a href="#">海鲜</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="dishes_list">
                        <div class="hd tr"><span class="change_other">换一组<i></i></span></div>
                        <ul class="dishes_list_ctn scale-transition clearfix">
                            <li class="dishes_item" data-index="1">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img1.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="2">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img2.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="3">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img3.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="4">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img4.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="5">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img5.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="6">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img6.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="7">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img7.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="8">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img8.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="9">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img9.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="10">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img10.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="11">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img11.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="12">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img12.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="13">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img13.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="14">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img14.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="15">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img15.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                            <li class="dishes_item" data-index="16">
                                <span class="quantity">2</span>
                                <div class="bg_animate"></div>
                                <div class="img_box selected_hdl"><img src="images/dishes_img16.jpg" /></div>
                                <div class="title">猪肉炒白菜</div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="right_area f_r">
                    <div id="fixed_bar">
                        <div class="addr_box">
                            <div class="hd">送餐地址</div>
                            <div class="bd">
                                <div class="no_results">
                                    <p>您还没有填写送餐地址</p>
                                    <div class="add_addr"><b>+</b>填写送餐地址</div>
                                </div>
                                <div class="addr_list none">
                                    <dl class="address clearfix"><dt>地址：</dt><dd></dd></dl>
                                    <dl class="mobile_phone clearfix"><dt>电话：</dt><dd></dd></dl>
                                    <div class="edit_addr"><b>+</b>修改送餐地址</div>
                                </div>
                            </div>
                        </div>
                        <div class="selected_dishes">
                            <div class="hd">已选择的</div>
                            <div class="bd">
                                <ul class="selected_dishes_ctn scrollbar">
                                    <li class="no_results">您还没有点菜</li>
                                </ul>
                                <div class="go_to_pay"><a href="javascript:void(0);" class="pay_btn">嗯，选好了</a></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog addr_form scale-transition">
            <div class="hd">填写送餐地址<i class="close_dialog" onClick="closeAddressForm()"></i></div>
            <div class="bd">
                <form id="address_form" action="">
                    <dl class="address_item clearfix">
                        <dt>选择区域</dt>
                        <dd>
                            <select name="region" id="selRegion" onchange="regionChange(this)">
                                <option value="">请选择...</option>
                            </select>
                            <select name="building" id="selBuilding" class="none">
                                <option value="">请选择...</option>
                            </select>
                        </dd>
                    </dl>
                    <dl class="address_item clearfix">
                        <dt>详细地址</dt>
                        <dd><input type="text" name="address" class="inputstyle" placeholder="详细街道门牌" /></dd>
                    </dl>
                    <dl class="address_item clearfix">
                        <dt>手机</dt>
                        <dd><input type="text" name="mobile" class="inputstyle" placeholder="手机号码" /></dd>
                    </dl>
                    <div style="padding: 0 15px;">
                        <input type="button" value="保存" class="sm_btn" />
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
		    var can_del = true;
		    var no_dishes = "您还没有点菜";
			var region_distribution = [{region_id: 10, region_name: "A区", building: [{building_id: 3, building_name: "3栋"}, {building_id: 4, building_name: "4栋"}]}, {region_id: 20, region_name: "B区", building: [{building_id: 5, building_name: "5栋"}, {building_id: 6, building_name: "6栋"}]}, {region_id: 30, region_name: "C区", building: [{building_id: 7, building_name: "7栋"}, {building_id: 8, building_name: "8栋"}]}];
		
			function resetForm(from){
				from.reset();
				$("label.error", from).remove();
			}
			function showAddressForm(){
				$("body").append("<div class='mask_layer'></div>");
				$(".addr_form").addClass("scale-in");
			}
			function closeAddressForm(){
				$(".mask_layer").remove();
				$(".addr_form").removeClass("scale-in");
				resetForm($("#address_form")[0]);
			}
			function regionChange(sel){
				if(sel.value == "" || sel.value == 0){
					$("#selBuilding")[0].selectedIndex = 0;
					$("#selBuilding").hide();
					return;
				}
				for(var i=0;i<region_distribution.length;i++){
					if(region_distribution[i]["region_id"] == sel.value){
						var building_option = '';
						for(var j=0;j<region_distribution[i]["building"].length;j++){
							building_option += '<option value="' + region_distribution[i]["building"][j]["building_id"] + '">' + region_distribution[i]["building"][j]["building_name"] + '</option>';
						}
						$("option", $("#selBuilding")).not(":first").remove();
						$("#selBuilding").append(building_option).show();
					}
				}
			}
			
			$(function(){
				var region_option = '';
				for(var i=0;i<region_distribution.length;i++){
					region_option += '<option value="' + region_distribution[i]["region_id"] + '">' + region_distribution[i]["region_name"] + '</option>';
				}
				region_option += '<option value="0">其他区</option>';
				$("#selRegion").append(region_option);
				
				$(".dishes_list_ctn").on("click",".selected_hdl",function(){
					var parent = $(this).parent();
					if(parent.hasClass("selected")){
						var quantity = $(".quantity",parent);
						var _quantity = $(".selected_dishes_ctn li").filter(function(){
							return $(this).data("index") == parent.data("index");
						}).find(".quantity");
						if(quantity.hasClass("scale-out-in-animation")){
							var num = Number(quantity.text()) + 1;
							quantity.removeClass("scale-out-in-animation").text(num);
							_quantity.removeClass("scale-out-in-animation").text("×" + num);
							setTimeout(function(){
								quantity.addClass("scale-out-in-animation");
								_quantity.addClass("scale-out-in-animation");
							} , 250);
						}
						else {
							quantity.addClass("scale-out-in-animation");
							_quantity.addClass("scale-out-in-animation");
						}
					}
					else {
						parent.addClass("selected");
						var selected_item = $('<li class="none opa" data-index="' + parent.data("index") + '"><img src="' + $("img",this).attr("src") + '" /><span>' + $(this).next().text() + '</span><span class="quantity">×2</span><i class="remove_dishes"></i></li>');
						$(".selected_dishes_ctn").find(".no_results").remove().end().prepend(selected_item);
						selected_item.slideDown(500).animate({opacity: 1}, 500);
					}
					$(".bg_animate",parent).addClass("scale-opa-out-animation");
					setTimeout(function(){
						$(".bg_animate",parent).removeClass("scale-opa-out-animation").css({"-webkit-transform": "scale(1,1)", "transform": "scale(1,1)", "background-color": "#2b8ae6"});
					} , 300);
					$(".go_to_pay").show();
				});
				$(".selected_dishes_ctn").on("click",".remove_dishes",function(){
					if(can_del){
						can_del = false;
						var _quantity = $(this).parent().find(".quantity");
						var quantity = $(".dishes_item").filter(function(){
							return $(this).data("index") == _quantity.parent().data("index");
						}).find(".quantity");
						if(_quantity.hasClass("scale-out-in-animation")){
							var num = Number(quantity.text());
							if(num > 2){
								quantity.removeClass("scale-out-in-animation").text(num - 1);
								_quantity.removeClass("scale-out-in-animation").text("×" + (num - 1));
								setTimeout(function(){
									quantity.addClass("scale-out-in-animation");
									_quantity.addClass("scale-out-in-animation");
									can_del = true;
								} , 250);
							}
							else {
								quantity.removeClass("scale-out-in-animation");
								_quantity.removeClass("scale-out-in-animation");
								can_del = true;
							}
						}
						else {
							quantity.parent().removeClass("selected");
							$(this).parent().animate({opacity: 0}, 500, function(){
								$(this).slideUp(500,function(){
									$(this).remove();
									if(!$(".selected_dishes_ctn li")[0]){
										$(".go_to_pay").hide();
										$(".selected_dishes_ctn").prepend('<li class="no_results">' + no_dishes + '</li>');
									}
									can_del = true;
								});
							});
						}
					}
				});
				$(".add_addr").bind("click", function() {
					showAddressForm();
				});
				$(".addr_form .sm_btn").bind("click", function(){
					var address = $("#address_form input[name=address]").val();
					var mobile = $("#address_form input[name=mobile]").val();
					$(".addr_list").show().find(".address dd").text(address).end().find(".mobile_phone dd").text(mobile);
					$(".addr_box .no_results").hide();
					closeAddressForm();
				});
				$(".edit_addr").bind("click", function(){
					showAddressForm();
					$("#address_form input[name=address]").val($(".addr_list .address dd").text());
					$("#address_form input[name=mobile]").val($(".addr_list .mobile_phone dd").text());
				});
				$(".change_other").bind("click", function(){
					$(".dishes_list_ctn").addClass("scale-out");
					setTimeout(function(){$(".dishes_list_ctn").removeClass("scale-out");} , 600);
				});
				
				$(".pay_btn").bind("click", function(){
					if($(".addr_list").is(":hidden")){
						alert("请填写送餐地址");
						return;
					}
					if(!$(".selected_dishes_ctn .opa")[0]){
						alert("请先选择菜品");
						return;
					}
					var cart = {};
					cart.goods = [];
					cart.address = $(".addr_list .address dd").text();
					cart.mobile_phone = $(".addr_list .mobile_phone dd").text();
					$(".selected_dishes_ctn .opa").each(function(){
						var goods_info = {};
						goods_info.id = $(this).data("index");
						goods_info.count = $(".quantity",this).hasClass("scale-out-in-animation") ? clearLetter($(".quantity",this).text()) : 1;
						cart.goods.push(goods_info);
					});
					$.ajax({
						url: '',
						type: 'post',
						data: cart,
						success: function(data) {
							if(data.error = 0){
								window.location.href = "";
							}
						}
					});
				});	
			});
        </script>
    </body>
</html>